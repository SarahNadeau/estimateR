---
title: "Impact of gamma fitting on Re estimates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(estimateR)
library(tibble)
library(Metrics)
library(hydroGOF)
library(ggplot2)
```


## Comparison of estimates for the two cases
### Comparing the deconvolved smoothed incidence values
```{r fit, warning=FALSE}
timesteps <- length(HK_incidence_data$case_incidence)
shape_incubation = 3.2 
scale_incubation = 1.3
incubation <- list(name="gamma", shape = shape_incubation, scale = scale_incubation)

set.seed(2)
delay_matrix_fit <- get_matrix_from_empirical_delay_distr(HK_delay_data, timesteps, fit_gamma_distrib = TRUE)
delay_matrix_no_fit <- get_matrix_from_empirical_delay_distr(HK_delay_data, timesteps, fit_gamma_distrib = FALSE)

shape_onset_to_report <- 2.7
scale_onset_to_report <- 1.6
onset_to_report <- list(name="gamma", shape = shape_onset_to_report, scale = scale_onset_to_report)

deconvolved_incidence_fit <- get_infections_from_incidence(incidence_data = HK_incidence_data$case_incidence,
                                delay_incubation = incubation,
                                delay_onset_to_report = delay_matrix_fit,
                                output_infection_incidence_only = FALSE,
                                ref_date = min(HK_incidence_data$date)) 

deconvolved_incidence_no_fit <- get_infections_from_incidence(incidence_data = HK_incidence_data$case_incidence,
                                delay_incubation = incubation,
                                delay_onset_to_report = delay_matrix_no_fit,
                                output_infection_incidence_only = FALSE,
                                ref_date = min(HK_incidence_data$date)) 

ggplot(data.frame(deconvolved_incidence_fit, deconvolved_incidence_no_fit)) +
geom_line(aes(y = deconvolved_incidence, x=date), lwd=  .5, color="red") +
geom_line(aes(y = deconvolved_incidence.1, x=date.1), lwd=  .5, color="blue") +
ylab("Deconvolved incidence") +
geom_line(aes(y = (deconvolved_incidence-deconvolved_incidence.1)/deconvolved_incidence, x=date), lwd=  .5, color="black") +
geom_line(aes(y = (deconvolved_incidence-deconvolved_incidence.1), x=date), lwd=  .5, color="purple") +
xlab("") +
scale_x_date(date_breaks = "1 month", 
             date_labels = '%b\n%d') +
theme_bw()
#print(deconvolved_incidence$deconvolved_incidence)

```
This graph shows us the value for the smooth deconvolved incidences in the case of fitting gamma distributions to the columns of the delay matrix (red line) as well as in the case of not fitting the columns (blue line). The purple line shows the difference in between the two estimates (gamma_fit - no_gamma fit). We can see that in periods of increasing incidence, the gamma fit estimates are slightly bigger, whereas in periods of decreasing incidence, the no gamma fit estimates are bigger. If we, however, divide the difference by the absolute value of the smoothed deconvolved incidence numbers (black line), we see that the two cases agree to a very high extent.


### Computing the Re estimates for the two cases
```{r no fit, warning=FALSE}
set.seed(2)
mean_serial_interval = 4.8
std_serial_interval = 2.3
estimation_window = 3

re_estimation_fit <- estimate_Re_from_noisy_delayed_incidence(HK_incidence_data$case_incidence,
                           smoothing_method = "LOESS",
                           deconvolution_method = "Richardson-Lucy delay distribution",
                           estimation_method = "EpiEstim sliding window",
                           delay_incubation = incubation,
                           delay_onset_to_report = delay_matrix_fit,
                           estimation_window = estimation_window,
                           mean_serial_interval = mean_serial_interval,
                           std_serial_interval  = std_serial_interval,
                           output_Re_only = FALSE,
                           time_step = "day"
  )

re_estimation_no_fit <- estimate_Re_from_noisy_delayed_incidence(HK_incidence_data$case_incidence,
                                                smoothing_method = "LOESS",
                                                deconvolution_method = "Richardson-Lucy delay distribution",
                                                estimation_method = "EpiEstim sliding window",
                                                delay_incubation = incubation,
                                                delay_onset_to_report = delay_matrix_no_fit,
                                                estimation_window = estimation_window,
                                                mean_serial_interval = mean_serial_interval,
                                                std_serial_interval  = std_serial_interval,
                                                output_Re_only = FALSE,
                                                time_step = "day"
  )

```

### Assessing the difference in estimates
```{r rmse re}
print(hydroGOF::rmse(re_estimation_fit$R_mean, re_estimation_no_fit$R_mean, na.rm=TRUE)/mean(re_estimation_fit$R_mean, na.rm=TRUE))
```

### Generating bootstrap samples to assess CIs
```{r bootstrap, warning=FALSE}
 N_bootstrap_replicates <- 100
  estimates_fit <- get_block_bootstrapped_estimate(HK_incidence_data$case_incidence,
                                               N_bootstrap_replicates = N_bootstrap_replicates,
                                               smoothing_method = "LOESS",
                                               deconvolution_method = "Richardson-Lucy delay distribution",
                                               estimation_method = "EpiEstim sliding window",
                                               uncertainty_summary_method = "original estimate - CI from bootstrap estimates",
                                               delay_incubation = incubation,
                                               delay_onset_to_report = delay_matrix_fit,
                                               estimation_window = estimation_window,
                                               mean_serial_interval = mean_serial_interval,
                                               std_serial_interval = std_serial_interval,
                                               ref_date = as.Date("2020-02-24"),
                                               time_step = "day"
  )
  
  estimates_no_fit <- get_block_bootstrapped_estimate(HK_incidence_data$case_incidence,
                                               N_bootstrap_replicates = N_bootstrap_replicates,
                                               smoothing_method = "LOESS",
                                               deconvolution_method = "Richardson-Lucy delay distribution",
                                               estimation_method = "EpiEstim sliding window",
                                               uncertainty_summary_method = "original estimate - CI from bootstrap estimates",
                                               delay_incubation = incubation,
                                               delay_onset_to_report = delay_matrix_no_fit,
                                               estimation_window = estimation_window,
                                               mean_serial_interval = mean_serial_interval,
                                               std_serial_interval = std_serial_interval,
                                               ref_date = as.Date("2020-02-24"),
                                               time_step = "day"
  )
```

### Plotting the results

The graph below shows a comparison between the Re estimates using the gamma fitted (red) and the unfitted (blue) delay matrices. The confidence intervals obtained by bootstrapping are displayed in light red (gamma fit) and light blue (no gamma fit). 
The pink line at the bottom of the graph shows the difference between the Re estimates (Re_gamma_fit - Re_no_gamma_fit.). This line will go above 0 when the estimates obtained using the unfitted delay matrix underestimate the Re values (compared to the gamma fit version).
I was interested to see under which circumstances Re_no_gamma_fit underestimate and under which circumstances they overestimate the Re values (compared to Re_gamma_fit). By visual inspection it seems like, when Re is on an increasing trend, Re_gamma_fit > Re_no_gamma_fit, and when Re is on a decreasing trend, Re_gamma_fit < Re_no_gamma_fit.
To better see this, I plotted the vertical lines that represent local minima of the absolute value of the difference between estimates (\code{abs(Re_gamma_fit - Re_no_gamma_fit)}).
We see that, around peaks, Re_no_gamma_fit is more confident in the estimates (which might not be a good thing(?)). In the very beginning of the epidemic, Re_no_gamma_fit severely overestimates. In recent time periods, however, both estimates agree, both in terms of absolute value, and CIs. 


```{r plotting, echo=FALSE}
 difference <- (estimates_fit[-1,]$Re_estimate-estimates_no_fit$Re_estimate)
  abs_difference <- abs(difference)
  indexes <- which(diff(sign(diff(abs_difference)))==2)+1
  
  vertical_lines = c()
  for(i in 1:length(indexes)){
    vertical_lines <- c(vertical_lines, as.numeric(estimates_no_fit$date[indexes[i]]))
  }

  ggplot(data.frame(estimates_fit[-1,], estimates_no_fit), aes(x = date)) + #remove first row of estimates_fit because it covers one day earlier than estimates_no_fit
    geom_vline(xintercept = vertical_lines)+
    geom_line(aes(y = Re_estimate), lwd=  .9, color="red") +
    geom_line(aes(y = Re_estimate.1), lwd=  .9, color="blue") +
    geom_line(aes(y = difference), lwd=  .9, color="pink") +
    geom_ribbon(aes(x = date, ymax = CI_up, ymin = CI_down, fill="CI Re fit"), alpha = 0.15, colour = NA) +
    geom_ribbon(aes(x = date, ymax = CI_up.1, ymin = CI_down.1, fill="CI Re no fit"), alpha = 0.15, colour = NA) +
    scale_fill_manual(values=c("red", "blue"), name="fill")+
    scale_x_date(date_breaks = "1 month", 
                 date_labels = '%b\n%d') +
    ylab("Reproductive number") +
    coord_cartesian(ylim = c(0, 3.7)) +
    xlab("") +
    theme_bw()
```





