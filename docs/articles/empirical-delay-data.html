<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Re estimation using empirical delay data • estimateR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Re estimation using empirical delay data">
<meta property="og:description" content="estimateR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">estimateR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/estimateR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/empirical-delay-data.html">Re estimation using empirical delay data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="empirical-delay-data_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Re estimation using empirical delay data</h1>
            
      
      
      <div class="hidden name"><code>empirical-delay-data.Rmd</code></div>

    </div>

    
    
<p>TODO rename vignette (both file name and vignette title) TODO there’s a lot of work to do on this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">estimateR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></code></pre></div>
<p>Aggregated case data for the Hong Kong COVID-19 epidemic. This data is derived from the linelist published by the Hong Kong <a href="https://www.chp.gov.hk">Centre for Health Protection</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Hong Kong incidence data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">HK_incidence_data</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 10 x 4</span>
<span class="co">#&gt;    date       case_incidence onset_incidence report_incidence</span>
<span class="co">#&gt;    &lt;date&gt;              &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 2020-01-18              0               1                0</span>
<span class="co">#&gt;  2 2020-01-19              0               0                0</span>
<span class="co">#&gt;  3 2020-01-20              0               1                0</span>
<span class="co">#&gt;  4 2020-01-21              0               3                0</span>
<span class="co">#&gt;  5 2020-01-22              0               2                0</span>
<span class="co">#&gt;  6 2020-01-23              2               4                0</span>
<span class="co">#&gt;  7 2020-01-24              3               0                0</span>
<span class="co">#&gt;  8 2020-01-25              0               4                0</span>
<span class="co">#&gt;  9 2020-01-26              3               1                0</span>
<span class="co">#&gt; 10 2020-01-27              0               0                0</span></code></pre></div>
<p>The original format of this data is a line list: it shows each recorded COVID-19 case in a separate row, with columns specifying different types of information that were (or were not) recorded for each case. These columns include the age and gender of the diseased individual, the name o the hospital they were admitted to (if applicable), the date of onset of symptoms and the reporting date. In general, the case report comes after the onset of symptoms.</p>
<p>We aggregated this data into 4 columns. In the <code>HK_incidence_data</code> dataframe, each row corresponds to a single date, and we count three types of incidence. The <code>case_incidence</code> entry for a particular day is the number of cases reported on that date. This is what we typically think of when we talk about incidence. Moreover, we use to our advantage the fact that we have access to the date of onset of symptoms for many diseased individuals. We build the <code>onset_incidence</code> column by summing, for each date, the number of individuals who started showing symptoms on this date. Thus we create a time series of ‘incidence’ of symptom onset events. For some individuals, the symptom onset date was not recorded. Therefore we build a third incidence column called <code>report_incidence</code>. In <code>report_incidence</code>, we sum all cases reported on a particular date, which do not have a recorded symptom onset date. This new incidence column is complementary to <code>onset_incidence</code>, which records symptom onset events.</p>
<p>We note that, for any particular date, summming the entries in <code>onset_incidence</code> and <code>report_incidence</code> generally does not equal the entry in the <code>case_incidence</code> column. This is normal sincea case counted on day X in the <code>case_incidence</code> column could appear on, e.g. day X - 3 in the <code>onset_incidence</code> column. However, it must be true that, for any particular date, ‘report_incidence’ ≤ ‘case_incidence’. Also, it must be true that the sum across all rows of <code>onset_incidence</code> plus that of <code>report_incidence</code> is equal to that of <code>case_incidence</code>. This sum amount to the total number of reported cases of COVID-19 in Honk-Kong over the time period of interest. Note that, in the original data some cases are reported as being asymptomatic. For simplicity, we treat these cases as if their date of onset of symptoms was unknown.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Total number of cases reported in Hong-Kong</span>
<span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">case_incidence</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 3271</span>

<span class="co"># Total number of cases when segreggating between cases for which we know the date of onset of symptoms and those for which we do not</span>
<span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">onset_incidence</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">report_incidence</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 3271</span>

<span class="co"># Both sums are equal, which is what we want.</span></code></pre></div>
<div id="first-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#first-analysis" class="anchor"></a>First analysis</h2>
<p>As a first rough analysis, we start by estimating the reproductive number through time only using the <code>case_incidence</code> column. We pretend that we only know about incidence through case confirmations. For many real-life cases, data on symptom onset date is not available, thus it is useful to consider this simpler use case.</p>
<p>To do this simplified analysis, we need an estimation of the delay distribution between infection and case report. We assume this delay can be separated into two independent components: an incubation period, from infection to onset of symptoms, and a delay from onset of symptoms until case report. Making such an assumption is quite safe, unless you have many recorded cases who were asymptomatic at the time of testing.</p>
<p>For the incubation period, we use here an estimate from the literature on COVID-19. TODO add ref</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Delay between infection and onset of symptoms (incubation period) in days</span>
<span class="co"># Gamma distribution parameter</span>
<span class="va">shape_incubation</span> <span class="op">&lt;-</span> <span class="fl">3.2</span>
<span class="va">scale_incubation</span> <span class="op">&lt;-</span> <span class="fl">1.3</span>

<span class="co"># Incubation period delay distribution</span>
<span class="va">distribution_incubation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"gamma"</span>, 
                                shape <span class="op">=</span> <span class="va">shape_incubation</span>, 
                                scale <span class="op">=</span> <span class="va">scale_incubation</span><span class="op">)</span></code></pre></div>
<p>For the period between the onset of symptoms and the case report, we could use an estimate from the academic literature as well. Here, we choose instead to build an estimation of this distribution directly from the data at hand. TODO add note below on why it can still be useful to this case even though then we could directly use the symptom onset data. From the same <a href="https://www.chp.gov.hk">Hong-Kong linelist</a> that let us build the <code>HK_incidence_data</code> dataframe shown above, we compiled a dataset of individual delays reported between onset of symptoms and case confirmation. The column <code>event_date</code> shows the date of onset of symptoms for a particular diseased individual, whereas <code>report_delay</code> shows the number of days that elapsed between the onset of symptoms and the case confirmation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Delay between onset of symptom and case report</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">HK_delay_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   event_date report_delay</span>
<span class="co">#&gt;   &lt;date&gt;            &lt;int&gt;</span>
<span class="co">#&gt; 1 2020-01-18            5</span>
<span class="co">#&gt; 2 2020-01-20            4</span>
<span class="co">#&gt; 3 2020-01-21            2</span>
<span class="co">#&gt; 4 2020-01-21            5</span>
<span class="co">#&gt; 5 2020-01-21            5</span>
<span class="co">#&gt; 6 2020-01-22            8</span></code></pre></div>
<p>We could feed this dataset directly to <strong>estimateR</strong>, as we will see below. Instead, to exemplify another use case, we choose here to build an estimate of the delay distribution by ourselves. It is this estimate that we will feed to <strong>estimateR</strong> in this first analysis. TODO add note on why we would go through the trouble of doing that (maybe data from elsewhere, or only few datapoints for which we have delay data, or no record of the correspondence between delay data and incidence data)</p>
<p>What we need to build is a vector containing the frequencies at which a delay (in number of days) occurs in the empirical data. These frequencies must be ordered, from the frequency of 0-day delays, to the frequency of the maximal delay observed (there can be trailing zeroes too). Here, we need to use increments of 1-day because that is the increment used in the incidence dataset (<code>HK_incidence_data</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">empirical_frequencies</span> <span class="op">&lt;-</span> <span class="va">HK_delay_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">report_delay</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Count the occurences of each delay</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>freq <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="co"># Transform into frequencies</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">empirical_frequencies</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;   report_delay     n    freq</span>
<span class="co">#&gt;          &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1            0    16 0.00543</span>
<span class="co">#&gt; 2            1   181 0.0614 </span>
<span class="co">#&gt; 3            2   414 0.140  </span>
<span class="co">#&gt; 4            3   421 0.143  </span>
<span class="co">#&gt; 5            4   384 0.130  </span>
<span class="co">#&gt; 6            5   343 0.116</span>

<span class="co"># Convert to a vector, keeping only the frequencies  </span>
  <span class="va">delay_onset_to_report</span> <span class="op">&lt;-</span> <span class="va">empirical_frequencies</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">report_delay</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Sort by increasing delay</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">freq</span><span class="op">)</span> <span class="co"># Pull frequencies as a vector</span></code></pre></div>
<p>We could go further one step further and fit a particular distribution (e.g. gamma or lognormal) to this empirical frequency vector. We may have especially wanted to do that if we had had few datapoints to inform the delay distribution. Fitting with a particular distribution could help smooth out the empirical frequencies in this case. When doing so, one needs to be mindful of zero values in the empirical delays, as not all distribution types allow for zeroes. TODO add code on how to do that(when extracting to other vignette).</p>
<p>Finally, we also need an estimate of the serial interval, the time between two successive cases in a transmission chain. We draw this estimate from the academic litterature TODO add ref</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Serial interval (for Re estimation) in days</span>
<span class="va">mean_serial_interval</span> <span class="op">&lt;-</span> <span class="fl">4.8</span>
<span class="va">std_serial_interval</span> <span class="op">&lt;-</span> <span class="fl">2.3</span></code></pre></div>
<div id="estimation-of-the-effective-reproductive-number-through-time" class="section level3">
<h3 class="hasAnchor">
<a href="#estimation-of-the-effective-reproductive-number-through-time" class="anchor"></a>Estimation of the effective reproductive number through time</h3>
<p>Given the data prepared above and the additional parameters informing the analysis, we run a simplified analysis of the Hong Kong data. The <code>estimation_window</code> parameter specifies the number of time steps (days here) over which the reproductive number is assumed to be constant. A window of 3 days means an estimate reported on day T was built assuming the reproductive number was constant over days T-2, T-1 and T. The 3-day window is then slid for the day T+1, which assumes a constant Re over T-1,T and T+1. The <code>minimum_cumul_incidence</code> parameter specifies the minimum cumulative incidence required for the reproductive number estimate to begin. If <code>minimum_cumul_incidence</code> is too low, the earliest Re estimates are too uncertain.</p>
<p>We use the <code>get_block_bootstrapped_estimate</code> function in order to not only estimate Re over the original data, but also produce confidence intervals. The <code>N_bootstrap_replicates</code> parameter lets us specify how many bootstrap replicates we want to run the estimation on. The more, the better the uncertainty estimate is, but the longer the estimate will take. Last, the <code>ref_date</code> argument lets us specify the date of the first incidence record in the <code>incidence_data</code> vector. <code>time_step</code> specifies the time step between two consecutive records in <code>incidence_data</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HK_first_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_block_bootstrapped_estimate.html">get_block_bootstrapped_estimate</a></span><span class="op">(</span>
  incidence_data <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">case_incidence</span>,
  N_bootstrap_replicates <span class="op">=</span> <span class="fl">100</span>,
  delay_incubation <span class="op">=</span> <span class="va">distribution_incubation</span>, 
  delay_onset_to_report <span class="op">=</span> <span class="va">delay_onset_to_report</span>,
  estimation_window <span class="op">=</span> <span class="fl">3</span>, <span class="co"># 3-day sliding window for the Re estimation</span>
  minimum_cumul_incidence <span class="op">=</span> <span class="fl">50</span>,
  mean_serial_interval <span class="op">=</span> <span class="va">mean_serial_interval</span>,
  std_serial_interval <span class="op">=</span> <span class="va">std_serial_interval</span>,
  ref_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>,
  time_step <span class="op">=</span> <span class="st">"day"</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">HK_first_estimates</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   date       Re_estimate CI_down CI_up</span>
<span class="co">#&gt;   &lt;date&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2020-02-06       0.954   0.689  1.22</span>
<span class="co">#&gt; 2 2020-02-07       0.901   0.645  1.16</span>
<span class="co">#&gt; 3 2020-02-08       0.854   0.608  1.10</span>
<span class="co">#&gt; 4 2020-02-09       0.828   0.561  1.10</span>
<span class="co">#&gt; 5 2020-02-10       0.838   0.572  1.10</span>
<span class="co">#&gt; 6 2020-02-11       0.874   0.559  1.19</span></code></pre></div>
<p>We have obtained our first estimates of Re for Hong Kong from February to July 2020. Let us now plot these estimates with their confidence interval.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">HK_first_estimates</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">Re_estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span>  <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, ymax <span class="op">=</span> <span class="va">CI_up</span>, ymin <span class="op">=</span> <span class="va">CI_down</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.45</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"1 month"</span>, 
               date_labels <span class="op">=</span> <span class="st">'%b\n%Y'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Reproductive number"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="empirical-delay-data_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
</div>
</div>
<div id="analysis-including-incidence-of-symptom-onset-events" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-including-incidence-of-symptom-onset-events" class="anchor"></a>Analysis including incidence of symptom onset events</h2>
<p>We could stop here, or try to get better informed estimates leveraging the data we have not used in the initial analysis. As discussed above, we can do is break down the incidence data into a ‘onset of symptoms’ incidence and a ‘case confirmation’ incidence. In the data, these correspond to <code>onset_incidence</code> and <code>report_incidence</code>.</p>
<p>We now use the <code>get_bootstrapped_estimates_from_combined_observations</code> function to combine these two incidence vectors together. The <code>partially_delayed_incidence</code> argument corresponds to the <code>onset_incidence</code>, because the symptom onset events are only delayed from the infection events by the incubation period. We thus call them ‘partially delayed’. The <code>report_incidence</code> on the other hand corresponds to case confirmation events, they are delayed from the original infection events by the incubation period, and by a delay between onset of symptom and confirmation. We call them ‘fully delayed’ and they correspond to the <code>fully_delayed_incidence</code> argument of <code>get_bootstrapped_estimates_from_combined_observations</code>. The <code>delay_until_partial</code> argument is thus the incubation period whereas the <code>delay_from_partial_to_full</code> argument is the delay from onset to report (or case confirmation). Something important to note here is that in order from someone to report that they started showing COVID-19 symptoms on day T, they first need to be confirmed as a positive case, which usually happens later than day T (e.g. T + 3 days). Because of this, we see a drop in the incidence of symptom onset events close to the present. Here the present is July 31st.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   date       case_incidence onset_incidence report_incidence</span>
<span class="co">#&gt;   &lt;date&gt;              &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2020-07-26            128              64               31</span>
<span class="co">#&gt; 2 2020-07-27            145              66               18</span>
<span class="co">#&gt; 3 2020-07-28            106              32               22</span>
<span class="co">#&gt; 4 2020-07-29            117              14               16</span>
<span class="co">#&gt; 5 2020-07-30            149               4               23</span>
<span class="co">#&gt; 6 2020-07-31            121               1               20</span></code></pre></div>
<p>This is to be expected, most people with symptoms appearing just before July 31st will be confirmed in August, thus they cannot have been recorded in our dataset, which emulates the present being July 31 2020. In order not to bias our estimates of Re close to the present, we need to account for this drop. Otherwise, Re will artificially seen as going down. This is all accounted for inside functions called by <code>get_bootstrapped_estimates_from_combined_observations</code>. We only need to set the <code>partial_observation_requires_full_observation</code> flag to <code>TRUE</code>, whenever our ‘partially-delayed’ observations requires the ‘fully-delayed’ observation to have happened.</p>
<p>All other parameters are kept the same as in the previous analysis, except for <code>N_bootstrap_replicates</code> which is set to 50 here, to save time on the vignette computations.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HK_combined_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_bootstrapped_estimates_from_combined_observations.html">get_bootstrapped_estimates_from_combined_observations</a></span><span class="op">(</span>
  partially_delayed_incidence <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">onset_incidence</span>,
  fully_delayed_incidence <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">report_incidence</span>,
  N_bootstrap_replicates <span class="op">=</span> <span class="fl">50</span>, <span class="co"># only 50 replicates to keep execution fast</span>
  delay_until_partial <span class="op">=</span> <span class="va">distribution_incubation</span>,
  delay_from_partial_to_full <span class="op">=</span> <span class="va">delay_onset_to_report</span>,
  partial_observation_requires_full_observation <span class="op">=</span> <span class="cn">TRUE</span>,
  minimum_cumul_incidence <span class="op">=</span> <span class="fl">50</span>,
  estimation_window <span class="op">=</span> <span class="fl">3</span>, <span class="co"># 3-day sliding window for the Re estimation</span>
  mean_serial_interval <span class="op">=</span> <span class="va">mean_serial_interval</span>,
  std_serial_interval <span class="op">=</span> <span class="va">std_serial_interval</span>,
  ref_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>,
  time_step <span class="op">=</span> <span class="st">"day"</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">HK_combined_estimates</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   date       Re_estimate CI_down CI_up</span>
<span class="co">#&gt;   &lt;date&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2020-02-03       0.926   0.744 1.11 </span>
<span class="co">#&gt; 2 2020-02-04       0.880   0.697 1.06 </span>
<span class="co">#&gt; 3 2020-02-05       0.836   0.634 1.04 </span>
<span class="co">#&gt; 4 2020-02-06       0.804   0.606 1.00 </span>
<span class="co">#&gt; 5 2020-02-07       0.785   0.591 0.979</span>
<span class="co">#&gt; 6 2020-02-08       0.780   0.586 0.973</span></code></pre></div>
<p>You may notice that the earliest Re estimates dates differ, this is a normal side effect of splitting the incidence data this way. We will plot them one on top of the other further down below, but you can already see that these estimates are different from the initial ones. In all likelihood, they are more accurate. By incorporating the empirical dates of symptom onset events, we bypassed the deconvolution step required to infer these dates from the case confirmation dates. Our goal is to produce an estimate of the incidence of infection events through time that is as close to reality as possible. When using the onset of symptoms, we are already halfway there. Thus, the estimates we produce using this additional data are likely to be closer to reality.</p>
</div>
<div id="further-analysis-including-variability-through-time-of-reporting-delays" class="section level2">
<h2 class="hasAnchor">
<a href="#further-analysis-including-variability-through-time-of-reporting-delays" class="anchor"></a>Further analysis including variability-through-time of reporting delays</h2>
<p>In both analyses above, the distribution of the delay between onset of symptoms and case confirmation was averaged through the entire period of interest. However, we could build a finer analysis by not averaging over the entire period of interest but instead allowing this distribution to vary through time. TODO add couple of sentences on why that could be nice to do (because can vary in reality). With <strong>estimateR</strong>, this can be done simply by feeding the empirical data directly to the function used for the analysis. Doing so will result in a decrease in computation speed, but this decrease should be relatively small.</p>
<p>We start by performing the same analysis an the first analysis, but this time we directly feed the <code>HK_delay_data</code> dataframe to the <code>delay_onset_to_report</code> argument of <code>get_block_bootstrapped_estimate</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HK_variable_delays_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_block_bootstrapped_estimate.html">get_block_bootstrapped_estimate</a></span><span class="op">(</span>
  incidence_data <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">case_incidence</span>,
  N_bootstrap_replicates <span class="op">=</span> <span class="fl">50</span>, <span class="co"># only 50 replicates to keep execution fast</span>
  delay_incubation <span class="op">=</span> <span class="va">distribution_incubation</span>, 
  delay_onset_to_report <span class="op">=</span> <span class="va">HK_delay_data</span>,
  estimation_window <span class="op">=</span> <span class="fl">3</span>, <span class="co"># 3-day sliding window for the Re estimation</span>
  minimum_cumul_incidence <span class="op">=</span> <span class="fl">50</span>,
  mean_serial_interval <span class="op">=</span> <span class="va">mean_serial_interval</span>,
  std_serial_interval <span class="op">=</span> <span class="va">std_serial_interval</span>,
  ref_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>,
  time_step <span class="op">=</span> <span class="st">"day"</span>
<span class="op">)</span></code></pre></div>
<p>We can do the same modification to the analysis above that included symptom onset data. As just before, we provide the <code>HK_delay_data</code> dataframe to the <code>delay_onset_to_report</code> argument:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">HK_variable_delays_combined_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_bootstrapped_estimates_from_combined_observations.html">get_bootstrapped_estimates_from_combined_observations</a></span><span class="op">(</span>
  partially_delayed_incidence <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">onset_incidence</span>,
  fully_delayed_incidence <span class="op">=</span> <span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">report_incidence</span>,
  N_bootstrap_replicates <span class="op">=</span> <span class="fl">50</span>, <span class="co"># only 50 replicates to keep execution fast</span>
  delay_until_partial <span class="op">=</span> <span class="va">distribution_incubation</span>,
  delay_from_partial_to_full <span class="op">=</span> <span class="va">HK_delay_data</span>,
  partial_observation_requires_full_observation <span class="op">=</span> <span class="cn">TRUE</span>,
  estimation_window <span class="op">=</span> <span class="fl">3</span>, <span class="co"># 3-day sliding window for the Re estimation</span>
   minimum_cumul_incidence <span class="op">=</span> <span class="fl">50</span>,
  mean_serial_interval <span class="op">=</span> <span class="va">mean_serial_interval</span>,
  std_serial_interval <span class="op">=</span> <span class="va">std_serial_interval</span>,
  ref_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">HK_incidence_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>,
  time_step <span class="op">=</span> <span class="st">"day"</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison" class="anchor"></a>Comparison</h2>
<p>Let us plot the results of these 4 analyses on a single plot to easily compare them. We first build a single dataframe containing the 4 types of result and then build the plot.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Add a column specifying the analysis type to each analysis result</span>
<span class="va">HK_variable_delays_estimates</span> <span class="op">&lt;-</span> <span class="va">HK_variable_delays_estimates</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`Estimate type` <span class="op">=</span> <span class="st">"Including variable delays"</span><span class="op">)</span>

<span class="va">HK_variable_delays_combined_estimates</span> <span class="op">&lt;-</span> <span class="va">HK_variable_delays_combined_estimates</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`Estimate type` <span class="op">=</span> <span class="st">"All available data"</span><span class="op">)</span>

<span class="va">HK_combined_estimates</span> <span class="op">&lt;-</span> <span class="va">HK_combined_estimates</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`Estimate type` <span class="op">=</span> <span class="st">"Including symptom onset data"</span><span class="op">)</span>

<span class="va">HK_first_estimates</span> <span class="op">&lt;-</span> <span class="va">HK_first_estimates</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`Estimate type` <span class="op">=</span> <span class="st">"Case incidence only"</span><span class="op">)</span>

<span class="co"># Gather in a single dataframe</span>
<span class="va">HK_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">HK_variable_delays_estimates</span>,
                               <span class="va">HK_combined_estimates</span>,
                               <span class="va">HK_first_estimates</span>,
                               <span class="va">HK_variable_delays_combined_estimates</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sjmgarnier/viridis">viridis</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: viridisLite</span>

<span class="va">color_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/viridisLite/man/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">HK_estimates</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">Re_estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">`Estimate type`</span><span class="op">)</span>, lwd<span class="op">=</span>  <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, ymax <span class="op">=</span> <span class="va">CI_up</span>, ymin <span class="op">=</span> <span class="va">CI_down</span>, fill <span class="op">=</span> <span class="va">`Estimate type`</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.15</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"1 month"</span>, 
               date_labels <span class="op">=</span> <span class="st">'%b\n%Y'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Reproductive number"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">color_scale</span>,
                      aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="empirical-delay-data_files/figure-html/unnamed-chunk-15-1.png" width="768"></p>
<p>First, we can compare the first analysis (blue curve ‘Case incidence only’) with the analysis that included the variability through time of reporting delays (yellow curve ‘Including variable delays’). The two traces are very close to one another, but there are small differences in timing and slope around peaks in particular in March and May.</p>
<p>Incorporating the dates of onset of symptoms had a significant effect on the first estimates (green curve vs. blue curve). The timing and height of peaks and valleys for instance is significantly different repeatedly (early March, early May, early June and mid-June). Adding the variability of delays between onset of symptoms and case confirmation date had much less effect for analyses incorporating the dates of onset of symptoms (green curve vs. purple curve). This makes sense because for the majority of cases, the date of onset of symptoms is known. Allowing the delays between onset of symptoms and case confirmation date to be closer to the empirical truth only affects those cases for which the onset of symptom date is unknown. Therefore, the magnitude of the effect of incorporating knowledge on the variability of onset-to-confirmation delays is much reduced overall.</p>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p><strong>estimateR</strong> can deal with different levels of precision in the input data.</p>
<p>Whenever available, including the dates of onset of symptoms is a good idea as it will significantly help the analysis. For the same reason, including empirical delay data in the analysis can be valuable, in particular in cases for which the delay distribution has significantly changed through time. As seen in the Hong Kong example, if the date of onset of symptoms is known for most cases then the additional effect of the empirical delay data will be reduced. Given that their inclusion can be computationally a bit costly, a trade-off between speed and precision can sometimes be found in not including them.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jérémie Scire, Jana Huisman, Daniel Angst, Ana Grosu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
