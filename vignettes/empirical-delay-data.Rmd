---
title: "Re estimation using empirical delay data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Re estimation using empirical delay data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

TODO there's a lot of work to do on this vignette.

```{r setup}
library(estimateR)
```

Aggregated case data for the Hong Kong COVID-19 epidemic.
This data is derived from the linelist published by the Hong Kong [Centre for Health Protection](https://www.chp.gov.hk).
```{r}
# Hong Kong incidence data
head(HK_incidence_data)

incidence <- HK_incidence_data$incidence
ref_date <- min(HK_incidence_data$report_date)
```

Dataset compiling the delay between onset of symptoms and case report for many cases reported in Hong Kong.
This data is also derived from the linelist published by the Hong Kong [Centre for Health Protection](https://www.chp.gov.hk).
```{r}
# Delay between onset of symptom and case report
head(HK_delay_data)
```

Other parameters required for Re estimation:
```{r}
# Delay between infection and onset of symptoms (incubation period)
shape_incubation <- 3.2
scale_incubation <- 1.3
distribution_incubation <- list(name = "gamma", 
                                shape = shape_incubation, 
                                scale = scale_incubation)

# Serial interval (for Re estimation)
mean_serial_interval <- 4.8
std_serial_interval <- 2.3

# Sliding estimation window (for Re estimation)
estimation_window <- 3
```

Estimation of the effective reproductive number through time
```{r message=FALSE, warning=FALSE}
N_bootstrap_replicates <- 10 # only 10 replicates to keep execution fast

HK_estimates <- get_block_bootstrapped_estimate(
  incidence,
  N_bootstrap_replicates = N_bootstrap_replicates,
  smoothing_method = "LOESS",
  deconvolution_method = "Richardson-Lucy delay distribution",
  estimation_method = "EpiEstim sliding window",
  uncertainty_summary_method = "bagged mean - CI from bootstrap estimates",
  delay_incubation = distribution_incubation,
  delay_onset_to_report = HK_delay_data,
  estimation_window = estimation_window,
  mean_serial_interval = mean_serial_interval,
  std_serial_interval = std_serial_interval,
  ref_date = ref_date,
  time_step = "day"
)

head(HK_estimates)
```


```{r, fig.width=7, fig.height=4}
library(ggplot2)
ggplot(HK_estimates, aes(x = date, y = Re_estimate)) +
  geom_line(lwd=  1.1) +
  geom_ribbon(aes(x = date, ymax = CI_up, ymin = CI_down), alpha = 0.15, colour = NA) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = '%b\n%Y') +
  ylab("Reproductive number") +
  coord_cartesian(ylim = c(0, 3.7)) +
  xlab("") +
  theme_bw()
```
TODO add bit about noise in the observations and thus we need to bootstrap: add bootstrapping and plot results with uncertainty.
